<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingreso a Piscina</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FAFAFA; } /* Fondo blanco para contraste */
        /* Nuevo Degradado Caribeño: de Amarillo Suave a Azul Profundo */
        .header-bg { 
            background-image: linear-gradient(to right top, #FFC107, #00BCD4, #0D47A1); /* Sol, Turquesa, Azul Profundo */
            height: 12rem; /* Altura para el efecto de gradiente */
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2);
        } 
        /* Eliminamos glass-card y su blur para mejorar legibilidad */
        .guest-card { transition: all 0.2s; }
        .guest-card-checked { background-color: #e0f7fa; border-left-color: #00BCD4; } /* Turquesa claro para marcado */
        .guest-card-unchecked { background-color: white; border-left-color: #e5e7eb; } /* Blanco para pendiente */
        .check-button {
            width: 3rem; 
            height: 3rem;
            min-width: 3rem;
            border-radius: 9999px; /* Circular */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
        }
        /* Color de fondo del contenedor principal */
        #app { background-color: #FAFAFA; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center">
        
        <!-- Encabezado Fijo y Controles (Estilo Caribeño/Acuático) -->
        <header class="w-full header-bg p-4 sticky top-0 z-10">
            
            <!-- Contenedor del Título y Logo -->
            <div class="relative flex items-center justify-center pt-2 mb-4">
                
                <!-- [INICIO] COLOCAR LOGO AQUÍ -->
                <!-- LOGO GRIS CORPORATIVO -->
                <img id="hotel-logo" 
                     src="logo1.png" 
                     alt="Logo del Hotel" 
                     onerror="this.style.display='none'"
                     class="absolute left-0 h-10 w-auto object-contain rounded-lg"
                >
                <!-- [FIN] COLOCAR LOGO AQUÍ -->
                
                <!-- Título Centrado -->
                <h1 class="text-xl font-extrabold text-white text-center">Control de Ingreso a Piscina</h1>
            </div>

            <!-- Controles Flotantes sobre el Header Background -->
            <div class="absolute w-full max-w-xl left-1/2 transform -translate-x-1/2 top-16 px-4">
                <div class="flex items-center space-x-2 w-full">
                    
                    <!-- Botón de Carga (CSV) -->
                    <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                    <button onclick="document.getElementById('file-input').click()"
                            id="upload-button"
                            class="p-2 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-800 transition duration-150 shadow-md text-xs whitespace-nowrap">
                        Cargar Lista
                    </button>
                    
                    <!-- Barra de Búsqueda (Estilo integrado) -->
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Buscar por Nombre, Habitación o Reserva..." 
                               class="w-full p-3 pl-10 border-2 border-white rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-inner"
                               oninput="searchGuests(this.value)">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                
                <!-- Contadores (Fondo blanco sólido, sin desenfoque) -->
                <div class="text-sm mt-4 p-4 rounded-xl shadow-xl bg-white border border-gray-200">
                    <div class="flex justify-between items-center text-gray-700">
                        <span id="guest-count" class="font-medium text-base">Cargando lista...</span>
                    </div>
                    <div class="mt-1 text-xl font-bold text-green-700"> 
                        <span id="entered-count">Ingresados: 0</span>
                    </div>
                </div>
            </div>
            
        </header>

        <!-- Contenedor del Checklist (AJUSTE CRÍTICO DEL MARGEN) -->
        <!-- mt-[10rem] asegura que la lista empiece POR DEBAJO de todo el encabezado fijo y flotante. -->
        <main id="guest-list-container" class="w-full max-w-xl p-4 space-y-3 pb-20 mt-[10rem]"> 
            <div id="loading-message" class="text-center p-8 text-gray-500">
                <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" ></path>
                </svg>
                <p class="mt-2">Iniciando base de datos...</p>
            </div>
        </main>

        <!-- Mensaje de Carga (Si la lista está vacía) -->
        <div id="empty-list-message" class="w-full max-w-xl p-8 hidden text-center bg-yellow-50 border border-yellow-200 rounded-xl mt-4">
            <p class="text-lg font-semibold text-yellow-800">¡Lista Vacía!</p>
            <p class="text-sm text-yellow-700 mt-2">Por favor, cargue su lista de huéspedes haciendo clic en el botón <span class="font-bold">"Cargar Lista (CSV)"</span>.</p>
            <p class="text-xs text-yellow-600 mt-2">Asegúrese de que su archivo CSV tenga las columnas: <span class="font-mono">Código Reserva, Nombre, Habitación</span>.</p>
        </div>

        <!-- Mensajes de Notificación (simula alert()) -->
        <div id="notification-area" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-20">
        </div>

    </div>
    
    <!-- Modal de Confirmación para Carga de Datos -->
    <div id="upload-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirmar Carga de Lista</h3>
            <p class="text-gray-700 mb-6">
                **ATENCIÓN**: Al cargar esta nueva lista de <span id="modal-guest-count" class="font-bold">0</span> huéspedes, se **borrará toda la lista actual** de la base de datos. ¿Desea continuar?
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                    <button id="modal-confirm-button" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">
                    Sí, Borrar y Cargar
                </button>
            </div>
        </div>
    </div>


    <!-- Script de Firebase (Módulos) -->
    <script type="module">
        // Importación de módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // --- CONFIGURACIÓN PARA EL HOSTING EN TU PROPIO SERVIDOR (GITHUB PAGES) ---
        // CLAVES DE TU PROYECTO FIREBASE 'control-piscina-48181'
        // =========================================================================
        
        // 2. Configuración de Firebase (CLAVES PÚBLICAS)
        const firebaseConfig = {
            apiKey: "AIzaSyD_vUGs0iDY0w45OlFjPCaOX58YI7J0xDI", 
            authDomain: "control-piscina-48181.firebaseapp.com", 
            projectId: "control-piscina-48181", 
            storageBucket: "control-piscina-48181.firebasestorage.app", 
            appId: "1:651276695583:web:02a25b22bcb52d5a05fd2a" 
        };
        
        // El token custom no se usa en hosting público. Se deja en null.
        const initialAuthToken = null; 
        
        // RUTA COMPARTIDA: Esta constante define la ubicación de los datos compartidos.
        const SHARED_COLLECTION_ID = "checklist_pool_data_v1";

        // =========================================================================
        // --- FIN DE CONFIGURACIÓN ---
        // =========================================================================

        let db;
        let auth;
        let currentUserId = null;
        let allGuests = []; // Almacena la lista completa de huéspedes.
        let parsedGuestData = []; // Almacena los datos del archivo CSV temporalmente.
        let currentSearchTerm = ''; // Variable global para guardar el término de búsqueda

        // --- FUNCIONES DE UTILIDAD ---

        /** Muestra una notificación temporal. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white px-4 py-2 rounded-xl shadow-xl text-sm mb-2 opacity-0 transition-opacity duration-300" 
                     style="min-width: 150px; text-align: center;">
                    ${message}
                </div>
            `;
            
            const notification = document.createElement('div');
            notification.innerHTML = html;
            const element = notification.firstElementChild;
            area.appendChild(element);

            // Mostrar
            setTimeout(() => { element.classList.remove('opacity-0'); }, 10);
            
            // Ocultar y eliminar
            setTimeout(() => {
                element.classList.add('opacity-0');
                element.addEventListener('transitionend', () => element.remove());
            }, 3000);
        }

        /** Inicializa Firebase y autenticación. */
        async function initializeFirebase() {
            try {
                // Validación de configuración para el entorno público
                if (!firebaseConfig.apiKey || firebaseConfig.projectId.includes('PEGA TU VALOR')) {
                    document.getElementById('loading-message').innerHTML = '<p class="text-red-600 font-bold">ERROR DE CONFIGURACIÓN: Por favor, reemplace las claves de Firebase en el código JS.</p>';
                    showNotification("Fallo: ¡Configuración de Firebase incompleta!", 'error');
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación anónima para obtener un user ID único
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    const userIdDisplay = document.getElementById('user-id-display');
                    const loadingMessage = document.getElementById('loading-message');

                    if (user) {
                        currentUserId = user.uid; 
                        // FIX: Comprobación de existencia del elemento antes de asignar textContent
                        if (userIdDisplay) {
                            userIdDisplay.textContent = `ID: ${currentUserId.substring(0, 8)}...`;
                        }
                        setupGuestListener();
                    } else {
                        // FIX: Comprobación de existencia del elemento antes de asignar textContent
                        if (loadingMessage) {
                            loadingMessage.textContent = "Error de autenticación. Recargue la página.";
                        }
                        showNotification("Fallo en la autenticación.", 'error');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showNotification(`Error de inicio: ${error.message}`, 'error');
            }
        }

        // --- LÓGICA DE FIRESTORE Y DATOS ---

        /** Obtiene la referencia de la colección de huéspedes compartida. */
        function getGuestsCollectionRef() {
            if (!db) return null;
            // Estructura COMPARTIDA: /pool_data/checklist_pool_data_v1/guests
            const collectionPath = `pool_data/${SHARED_COLLECTION_ID}/guests`;
            return collection(db, collectionPath);
        }

        /** Borra todos los documentos de la colección actual. */
        async function clearAllGuests() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;
            
            showNotification("Borrando lista anterior...", 'error');
            const snapshot = await getDocs(guestRef);
            
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref).catch(e => console.error("Fallo al borrar doc:", e)));
            });
            
            await Promise.all(deletePromises);
            showNotification("Lista anterior borrada.", 'success');
        }

        /** Inicializa la base de datos con los datos proporcionados. */
        async function initializeGuestData(guestDataArray) {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            const uploadButton = document.getElementById('upload-button');
            uploadButton.disabled = true;
            uploadButton.textContent = "Subiendo...";

            const batchSize = 50; // Límite de operaciones de escritura por batch
            
            for (let i = 0; i < guestDataArray.length; i += batchSize) {
                const batchPromises = guestDataArray.slice(i, i + batchSize).map(guest => {
                    const docToCreate = doc(guestRef);
                    return setDoc(docToCreate, {
                        ...guest,
                        createdAt: serverTimestamp(),
                        id: docToCreate.id 
                    });
                });
                await Promise.all(batchPromises);
            }
            
            uploadButton.disabled = false;
            uploadButton.textContent = "Cargar Lista (CSV)";
            showNotification("Lista actualizada exitosamente.", 'success');
        }

        /** Carga la lista de huéspedes en tiempo real. */
        async function setupGuestListener() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            onSnapshot(guestRef, (snapshot) => {
                const loadingMessage = document.getElementById('loading-message');
                const emptyMessage = document.getElementById('empty-list-message');

                if (snapshot.empty) {
                    allGuests = [];
                    loadingMessage?.remove();
                    if(emptyMessage) emptyMessage.classList.remove('hidden');
                } else {
                    if(emptyMessage) emptyMessage.classList.add('hidden');
                    loadingMessage?.remove();
                    
                    allGuests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Ordenar alfabéticamente por nombre
                    allGuests.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Al recibir datos, volvemos a renderizar, aplicando el filtro actual.
                    renderList(allGuests); 
                }
            }, (error) => {
                // ESTA ES LA FUNCIÓN DONDE SE REGISTRA EL ERROR DE PERMISOS
                console.error("Error al escuchar la colección:", error);
                showNotification("Error de conexión a la lista. (Verifique reglas de seguridad)", 'error');
            });
        }

        /**
         * Actualiza el estado de check-in/check-out de un huésped en Firestore.
         */
        window.toggleCheckin = async function(guestId, currentStatus) {
            const newStatus = !currentStatus;
            const guestRef = getGuestsCollectionRef();
            
            if (!guestRef) {
                showNotification("Error: Base de datos no disponible.", 'error');
                return;
            }

            try {
                const docToUpdate = doc(guestRef, guestId);
                await setDoc(docToUpdate, { isChecked: newStatus }, { merge: true });
                
                // NOTA CRÍTICA: Una vez que se actualiza el estado, onSnapshot se dispara 
                // y llama a renderList(), lo cual ya mantiene el filtro. No necesitamos forzar render aquí.

            } catch (error) {
                console.error("Error al actualizar el estado:", error);
                showNotification("Error al actualizar la base de datos.", 'error');
            }
        }

        // --- LÓGICA DE CARGA DE ARCHIVO Y PARSER ---

        /** * Implementa un simple parser CSV. AHORA SOPORTA COMA (,), PUNTO Y COMA (;) Y TABULADOR (\t)
         * ESPERA TRES COLUMNAS: Código Reserva (0), Cliente (1), Habitación (2).
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return [];

            // Determinar el separador: buscar el más común en la primera línea de datos
            const firstDataLine = lines[1];
            let separator = ','; // Default (coma)
            
            if (firstDataLine.indexOf(';') !== -1) {
                separator = ';'; // Separador es punto y coma
            } else if (firstDataLine.indexOf('\t') !== -1) { 
                separator = '\t'; // Separador es tabulador
            }
            // Si no encuentra ninguno, asume la coma.

            const data = [];

            // Iteramos desde la segunda línea (i=1) para ignorar el encabezado
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                let values;
                
                if (separator === ';' || separator === '\t') {
                    // Si es punto y coma o tabulador, simplemente separamos por ese carácter
                    values = line.split(separator);
                } else {
                    // Separador es coma (',')
                    values = line.split(separator);
                }
                
                // Limpiamos los valores de comillas y espacios
                const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

                // Asumiendo que las TRES primeras columnas son: Código Reserva, Nombre, Habitación
                if (cleanValues.length >= 3 && cleanValues[0] && cleanValues[1] && cleanValues[2]) {
                    data.push({
                        reservationCode: cleanValues[0], // Columna 1
                        name: cleanValues[1],           // Columna 2
                        room: cleanValues[2],           // Columna 3
                        isChecked: false 
                    });
                }
            }
            return data;
        }

        /** Maneja la subida del archivo CSV y lo parsea. */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification("Por favor, suba un archivo CSV (el formato más simple para Excel).", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    // Si no hay datos, muestra el error de formato
                    showNotification("El archivo CSV está vacío o mal formateado. Revise el formato.", 'error');
                    return;
                }
                
                // Almacenar los datos para la confirmación
                parsedGuestData = data;
                
                // Mostrar confirmación antes de borrar y cargar.
                showConfirmModal(data.length);
            };
            reader.readAsText(file);
            // Limpiar el input file
            event.target.value = null; 
        }

        // --- LÓGICA DE MODAL DE CONFIRMACIÓN ---

        const modal = document.getElementById('upload-confirm-modal');
        const modalCount = document.getElementById('modal-guest-count');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        function showConfirmModal(count) {
            modalCount.textContent = count;
            modal.classList.remove('hidden');
            
            // Re-adjuntar el listener para evitar duplicados
            modalConfirmButton.onclick = async () => {
                closeConfirmModal();
                await clearAllGuests();
                await initializeGuestData(parsedGuestData);
                parsedGuestData = []; // Limpiar la data temporal
            };
        }

        window.closeConfirmModal = function() {
            modal.classList.add('hidden');
        }

        // --- LÓGICA DE RENDERIZADO Y BÚSQUEDA ---

        /** Filtra la lista de huéspedes en base al término de búsqueda actual. */
        window.searchGuests = function(searchTerm) {
            // Se actualiza el término de búsqueda global
            currentSearchTerm = searchTerm.toLowerCase().trim();
            
            // Disparamos la renderización para que use el nuevo filtro inmediatamente
            renderList(allGuests);
        }

        /** Renderiza la lista de huéspedes en el contenedor. */
        function renderList(guests) {
            const container = document.getElementById('guest-list-container');
            const countDisplay = document.getElementById('guest-count');
            const enteredCountDisplay = document.getElementById('entered-count'); // NUEVO ELEMENTO
            
            if (!container) return;
            
            // 1. Aplicar el filtro si existe un término de búsqueda
            const guestsToRender = currentSearchTerm 
                ? guests.filter(guest => 
                    guest.name.toLowerCase().includes(currentSearchTerm) || 
                    (guest.room && guest.room.toLowerCase().includes(currentSearchTerm)) || 
                    (guest.reservationCode && guest.reservationCode.toLowerCase().includes(currentSearchTerm))
                )
                : guests;

            // CALCULAR CONTADOR DE INGRESADOS (siempre sobre allGuests)
            const enteredCount = allGuests.filter(guest => guest.isChecked).length;
            
            // Actualizar contadores
            countDisplay.textContent = `Total de Huéspedes: ${allGuests.length}`;
            enteredCountDisplay.textContent = `Ingresados: ${enteredCount}`;
            
            if (guestsToRender.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">No se encontraron huéspedes con esa búsqueda.</p>';
                return;
            }

            // Generar el HTML de las tarjetas
            const html = guestsToRender.map(guest => {
                const checked = guest.isChecked;
                const baseClasses = "guest-card w-full p-3 flex justify-between items-center rounded-xl shadow-md cursor-pointer select-none border-l-8";
                const checkBg = checked ? "guest-card-checked" : "guest-card-unchecked";
                
                // Icono + o Checkmark
                const icon = checked ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>` : 
                    `<svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;


                return `
                    <div class="${baseClasses} ${checkBg}" onclick="toggleCheckin('${guest.id}', ${checked})">
                        <!-- Información del Huésped -->
                        <div class="flex-grow min-w-0 pr-4">
                            <p class="text-lg font-bold truncate ${checked ? 'text-green-700' : 'text-gray-900'}">
                                ${guest.name}
                            </p>
                            <div class="flex flex-wrap text-xs text-gray-500 mt-1">
                                <span class="truncate pr-2">Reserva: <span class="font-medium">${guest.reservationCode}</span></span>
                                <span class="font-bold text-gray-400 hidden sm:inline">|</span>
                                <span class="pl-0 sm:pl-2 text-base font-bold text-gray-700">Hab: <span class="font-extrabold">${guest.room}</span></span>
                            </div>
                            <p class="text-xs ${checked ? 'text-green-500 font-bold' : 'text-red-500 font-semibold'} mt-1 uppercase">
                                ${checked ? 'INGRESADO' : 'PENDIENTE DE INGRESO'}
                            </p>
                        </div>
                        
                        <!-- Toggle Button (Área de toque grande y circular) -->
                        <div class="check-button ${checked ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-200 hover:bg-gray-300' } flex items-center justify-center">
                            ${icon}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Iniciar la aplicación al cargar la ventana
        window.onload = initializeFirebase;

    </script>
</body>
</html>