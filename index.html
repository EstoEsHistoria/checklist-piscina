<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Huéspedes - Piscina</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .guest-card { transition: transform 0.2s, box-shadow 0.2s; }
        .guest-card:active { transform: translateY(0); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); } /* Efecto al tocar en móvil */
        .check-toggle {
            cursor: pointer;
            width: 3rem; 
            height: 3rem;
            min-width: 3rem;
        }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center">
        
        <!-- Encabezado Fijo y Controles -->
        <header class="w-full bg-white shadow-lg p-4 sticky top-0 z-10">
            <h1 class="text-xl font-bold text-blue-800 text-center mb-2">Control de Ingreso a Piscina</h1>
            
            <!-- Barra de Búsqueda y Botón de Carga -->
            <div class="flex flex-col sm:flex-row justify-between mt-3 space-y-2 sm:space-y-0 sm:space-x-2">
                
                <!-- Barra de Búsqueda -->
                <input type="text" id="search-input" placeholder="Buscar por Nombre, Reserva o Habitación..." 
                       class="w-full sm:w-2/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700 shadow-inner"
                       oninput="searchGuests(this.value)">

                <!-- Botón de Carga (Simulación) -->
                <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                <button onclick="document.getElementById('file-input').click()"
                        id="upload-button"
                        class="w-full sm:w-1/3 p-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center text-sm sm:text-base">
                    Cargar Lista (CSV)
                </button>
            </div>
            
            <!-- Indicador de Huéspedes y UserId (Optimizado para móvil) -->
            <div class="text-sm text-gray-500 mt-3 flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                <div class="flex flex-col space-y-1 sm:space-y-0 sm:flex-row sm:space-x-4">
                    <span id="guest-count" class="font-medium text-gray-700 text-xs sm:text-sm">Cargando lista...</span>
                    <span id="entered-count" class="text-sm font-bold text-green-700">Ingresados: 0</span> <!-- Contador de Ingresados -->
                </div>
                <span id="user-id-display" title="ID de Sesión (Ya no se usa para datos)" class="text-xs text-gray-500 truncate max-w-[4rem] sm:max-w-none">ID: N/A</span>
            </div>
        </header>

        <!-- Contenedor del Checklist -->
        <main id="guest-list-container" class="w-full max-w-xl p-4 space-y-3 pb-20">
            <div id="loading-message" class="text-center p-8 text-gray-500">
                <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" ></path>
                </svg>
                <p class="mt-2">Iniciando base de datos...</p>
            </div>
        </main>

        <!-- Mensaje de Carga (Si la lista está vacía) -->
        <div id="empty-list-message" class="w-full max-w-xl p-8 hidden text-center bg-yellow-50 border border-yellow-200 rounded-xl mt-4">
            <p class="text-lg font-semibold text-yellow-800">¡Lista Vacía!</p>
            <p class="text-sm text-yellow-700 mt-2">Por favor, cargue su lista de huéspedes haciendo clic en el botón <span class="font-bold">"Cargar Lista (CSV)"</span>.</p>
            <p class="text-xs text-yellow-600 mt-2">Asegúrese de que su archivo CSV tenga las columnas: <span class="font-mono">Código Reserva, Nombre, Habitación</span>.</p>
        </div>

        <!-- Mensajes de Notificación (simula alert()) -->
        <div id="notification-area" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-20">
        </div>

    </div>
    
    <!-- Modal de Confirmación para Carga de Datos -->
    <div id="upload-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirmar Carga de Lista</h3>
            <p class="text-gray-700 mb-6">
                **ATENCIÓN**: Al cargar esta nueva lista de <span id="modal-guest-count" class="font-bold">0</span> huéspedes, se **borrará toda la lista actual** de la base de datos. ¿Desea continuar?
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button id="modal-confirm-button" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">
                    Sí, Borrar y Cargar
                </button>
            </div>
        </div>
    </div>


    <!-- Script de Firebase (Módulos) -->
    <script type="module">
        // Importación de módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // --- CONFIGURACIÓN PARA EL HOSTING EN TU PROPIO SERVIDOR (GITHUB PAGES) ---
        // CLAVES DE TU PROYECTO FIREBASE 'control-piscina-48181'
        // =========================================================================
        
        // 1. La ruta simplificada ya no necesita la variable appId
        // const appId = 'checklist-piscina-hotel';

        // 2. Configuración de Firebase (CLAVES PÚBLICAS)
        const firebaseConfig = {
            apiKey: "AIzaSyD_vUGs0iDY0w45OlFjPCaOX58YI7J0xDI", 
            authDomain: "control-piscina-48181.firebaseapp.com", 
            projectId: "control-piscina-48181", 
            storageBucket: "control-piscina-48181.firebasestorage.app", 
            messagingSenderId: "651276695583", 
            appId: "1:651276695583:web:02a25b22bcb52d5a05fd2a" 
        };
        
        // El token custom no se usa en hosting público. Se deja en null.
        const initialAuthToken = null; 
        
        // RUTA COMPARTIDA: Esta constante define la ubicación de los datos compartidos.
        const SHARED_COLLECTION_ID = "checklist_pool_data_v1";

        // =========================================================================
        // --- FIN DE CONFIGURACIÓN ---
        // =========================================================================

        let db;
        let auth;
        let currentUserId = null;
        let allGuests = []; // Almacena la lista completa de huéspedes.
        let parsedGuestData = []; // Almacena los datos del archivo CSV temporalmente.

        // --- FUNCIONES DE UTILIDAD ---

        /** Muestra una notificación temporal. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white px-4 py-2 rounded-xl shadow-xl text-sm mb-2 opacity-0 transition-opacity duration-300" 
                     style="min-width: 150px; text-align: center;">
                    ${message}
                </div>
            `;
            
            const notification = document.createElement('div');
            notification.innerHTML = html;
            const element = notification.firstElementChild;
            area.appendChild(element);

            // Mostrar
            setTimeout(() => { element.classList.remove('opacity-0'); }, 10);
            
            // Ocultar y eliminar
            setTimeout(() => {
                element.classList.add('opacity-0');
                element.addEventListener('transitionend', () => element.remove());
            }, 3000);
        }

        /** Inicializa Firebase y autenticación. */
        async function initializeFirebase() {
            try {
                // Validación de configuración para el entorno público
                if (!firebaseConfig.apiKey || firebaseConfig.projectId.includes('PEGA TU VALOR')) {
                    document.getElementById('loading-message').innerHTML = '<p class="text-red-600 font-bold">ERROR DE CONFIGURACIÓN: Por favor, reemplace las claves de Firebase en el código JS.</p>';
                    showNotification("Fallo: ¡Configuración de Firebase incompleta!", 'error');
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación anónima para obtener un user ID único
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // El userId se sigue guardando pero ya NO se usa para la ruta de los datos compartidos.
                        currentUserId = user.uid; 
                        document.getElementById('user-id-display').textContent = `ID: ${currentUserId.substring(0, 8)}...`;
                        setupGuestListener();
                    } else {
                        showNotification("Fallo en la autenticación.", 'error');
                        document.getElementById('loading-message').textContent = "Error de autenticación. Recargue la página.";
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showNotification(`Error de inicio: ${error.message}`, 'error');
            }
        }

        // --- LÓGICA DE FIRESTORE Y DATOS ---

        /** Obtiene la referencia de la colección de huéspedes compartida. */
        function getGuestsCollectionRef() {
            if (!db) return null;
            // Estructura COMPARTIDA: /pool_data/checklist_pool_data_v1/guests
            // Todos los usuarios autenticados (anónimos) accederán a esta misma ruta.
            return collection(db, `pool_data/${SHARED_COLLECTION_ID}/guests`);
        }

        /** Borra todos los documentos de la colección actual. */
        async function clearAllGuests() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;
            
            showNotification("Borrando lista anterior...", 'error');
            const snapshot = await getDocs(guestRef);
            
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref).catch(e => console.error("Fallo al borrar doc:", e)));
            });
            
            await Promise.all(deletePromises);
            showNotification("Lista anterior borrada.", 'success');
        }

        /** Inicializa la base de datos con los datos proporcionados. */
        async function initializeGuestData(guestDataArray) {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            const uploadButton = document.getElementById('upload-button');
            uploadButton.disabled = true;
            uploadButton.textContent = "Subiendo...";

            console.log(`Cargando ${guestDataArray.length} huéspedes...`);

            const batchSize = 50; // Límite de operaciones de escritura por batch
            
            for (let i = 0; i < guestDataArray.length; i += batchSize) {
                // No se usa batch real, se usa un loop de promesas para evitar timeouts
                const batchPromises = guestDataArray.slice(i, i + batchSize).map(guest => {
                    const docToCreate = doc(guestRef);
                    return setDoc(docToCreate, {
                        ...guest,
                        createdAt: serverTimestamp(),
                        id: docToCreate.id 
                    });
                });
                await Promise.all(batchPromises);
            }
            
            uploadButton.disabled = false;
            uploadButton.textContent = "Cargar Lista (CSV)";
            showNotification("Lista actualizada exitosamente.", 'success');
        }

        /** Carga la lista de huéspedes en tiempo real. */
        async function setupGuestListener() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            onSnapshot(guestRef, (snapshot) => {
                const loadingMessage = document.getElementById('loading-message');
                const emptyMessage = document.getElementById('empty-list-message');

                if (snapshot.empty) {
                    allGuests = [];
                    loadingMessage?.remove();
                    if(emptyMessage) emptyMessage.classList.remove('hidden');
                } else {
                    if(emptyMessage) emptyMessage.classList.add('hidden');
                    loadingMessage?.remove();
                    
                    allGuests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Ordenar alfabéticamente por nombre
                    allGuests.sort((a, b) => a.name.localeCompare(b.name));
                    
                    renderList(allGuests);
                }
            }, (error) => {
                console.error("Error al escuchar la colección:", error);
                showNotification("Error de conexión a la lista. (Verifique reglas de seguridad)", 'error');
            });
        }

        /**
         * Actualiza el estado de check-in/check-out de un huésped en Firestore.
         */
        window.toggleCheckin = async function(guestId, currentStatus) {
            const newStatus = !currentStatus;
            const guestRef = getGuestsCollectionRef();
            
            if (!guestRef) {
                showNotification("Error: Base de datos no disponible.", 'error');
                return;
            }

            try {
                const docToUpdate = doc(guestRef, guestId);
                await setDoc(docToUpdate, { isChecked: newStatus }, { merge: true });
                
                const guestName = allGuests.find(g => g.id === guestId)?.name || 'Huésped';
                // La notificación se dispara, pero el renderizado lo hará onSnapshot.
                // showNotification(newStatus ? `${guestName} ingresó.` : `${guestName} salió.`, 'success'); 

            } catch (error) {
                console.error("Error al actualizar el estado:", error);
                showNotification("Error al actualizar la base de datos.", 'error');
            }
        }

        // --- LÓGICA DE CARGA DE ARCHIVO Y PARSER ---

        /** * Implementa un simple parser CSV. AHORA SOPORTA COMA (,), PUNTO Y COMA (;) Y TABULADOR (\t)
         * ESPERA TRES COLUMNAS: Código Reserva (0), Cliente (1), Habitación (2).
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return [];

            // Determinar el separador: buscar el más común en la primera línea de datos
            const firstDataLine = lines[1];
            let separator = ','; // Default (coma)
            
            if (firstDataLine.indexOf(';') !== -1) {
                separator = ';'; // Separador es punto y coma
            } else if (firstDataLine.indexOf('\t') !== -1) { 
                separator = '\t'; // Separador es tabulador
            }
            // Si no encuentra ninguno, asume la coma.

            const data = [];

            // Iteramos desde la segunda línea (i=1) para ignorar el encabezado
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                let values;
                
                if (separator === ';' || separator === '\t') {
                    // Si es punto y coma o tabulador, simplemente separamos por ese carácter
                    values = line.split(separator);
                } else {
                    // Separador es coma (',') - usamos regex para comas dentro de comillas (si las hubiera)
                    // NOTA: Esta regex es compleja y puede fallar con formatos no estándar. Simplificaremos a split.
                    values = line.split(separator);
                }
                
                // Limpiamos los valores de comillas y espacios
                const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

                // Asumiendo que las TRES primeras columnas son: Código Reserva, Nombre, Habitación
                if (cleanValues.length >= 3 && cleanValues[0] && cleanValues[1] && cleanValues[2]) {
                    data.push({
                        reservationCode: cleanValues[0], // Columna 1
                        name: cleanValues[1],           // Columna 2
                        room: cleanValues[2],           // Columna 3
                        isChecked: false 
                    });
                }
            }
            return data;
        }

        /** Maneja la subida del archivo CSV y lo parsea. */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification("Por favor, suba un archivo CSV (el formato más simple para Excel).", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    // Si no hay datos, muestra el error de formato
                    showNotification("El archivo CSV está vacío o mal formateado. Revise el formato.", 'error');
                    return;
                }
                
                // Almacenar los datos para la confirmación
                parsedGuestData = data;
                
                // Mostrar confirmación antes de borrar y cargar.
                showConfirmModal(data.length);
            };
            reader.readAsText(file);
            // Limpiar el input file
            event.target.value = null; 
        }

        // --- LÓGICA DE MODAL DE CONFIRMACIÓN ---

        const modal = document.getElementById('upload-confirm-modal');
        const modalCount = document.getElementById('modal-guest-count');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        function showConfirmModal(count) {
            modalCount.textContent = count;
            modal.classList.remove('hidden');
            
            // Re-adjuntar el listener para evitar duplicados
            modalConfirmButton.onclick = async () => {
                closeConfirmModal();
                await clearAllGuests();
                await initializeGuestData(parsedGuestData);
                parsedGuestData = []; // Limpiar la data temporal
            };
        }

        window.closeConfirmModal = function() {
            modal.classList.add('hidden');
        }

        // --- LÓGICA DE RENDERIZADO Y BÚSQUEDA ---

        /** Filtra la lista de huéspedes en base al texto de búsqueda. */
        window.searchGuests = function(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (term === "") {
                renderList(allGuests);
                return;
            }

            const filteredList = allGuests.filter(guest => 
                guest.name.toLowerCase().includes(term) || 
                (guest.room && guest.room.toLowerCase().includes(term)) || // Búsqueda por Habitación
                (guest.reservationCode && guest.reservationCode.toLowerCase().includes(term)) // Búsqueda por Código de Reserva
            );
            
            renderList(filteredList);
        }

        /** Renderiza la lista de huéspedes en el contenedor. */
        function renderList(guestsToRender) {
            const container = document.getElementById('guest-list-container');
            const countDisplay = document.getElementById('guest-count');
            const enteredCountDisplay = document.getElementById('entered-count'); // NUEVO ELEMENTO
            
            if (!container) return;
            
            // CALCULAR CONTADOR DE INGRESADOS
            const enteredCount = allGuests.filter(guest => guest.isChecked).length;
            
            // Actualizar contadores
            countDisplay.textContent = `Total de Huéspedes: ${allGuests.length}`;
            enteredCountDisplay.textContent = `Ingresados: ${enteredCount}`;
            
            if (guestsToRender.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">No se encontraron huéspedes con esa búsqueda.</p>';
                return;
            }

            // Generar el HTML de las tarjetas
            const html = guestsToRender.map(guest => {
                const checked = guest.isChecked;
                const baseClasses = "guest-card w-full p-3 flex justify-between items-center rounded-xl shadow-md cursor-pointer select-none border-l-8";
                const checkBg = checked ? "bg-green-100 border-green-500" : "bg-white border-gray-300";
                const checkIcon = checked ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white bg-green-500 rounded-full p-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>` : 
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;
                
                return `
                    <div class="${baseClasses} ${checkBg}" onclick="toggleCheckin('${guest.id}', ${checked})">
                        <!-- Información del Huésped -->
                        <div class="flex-grow min-w-0 pr-4">
                            <p class="text-lg font-semibold truncate ${checked ? 'text-gray-700' : 'text-gray-900'}">
                                ${guest.name}
                            </p>
                            <div class="flex flex-col sm:flex-row sm:space-x-3 text-sm ${checked ? 'text-green-600 font-medium' : 'text-gray-500'} mt-1">
                                <span class="text-gray-400 font-normal truncate max-w-full sm:max-w-xs">Reserva: <span class="font-medium text-gray-600">${guest.reservationCode}</span></span>
                                <span class="hidden sm:inline">|</span>
                                <span class="text-gray-400 font-normal">Hab: <span class="font-medium text-gray-600">${guest.room}</span></span>
                            </div>
                            <p class="text-xs ${checked ? 'text-green-700' : 'text-gray-400'} mt-1">
                                ${checked ? 'MARCADO COMO INGRESADO' : 'PENDIENTE DE INGRESO'}
                            </p>
                        </div>
                        
                        <!-- Toggle de Check-in (Área de toque grande) -->
                        <div class="check-toggle flex items-center justify-center">
                            ${checkIcon}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Iniciar la aplicación al cargar la ventana
        window.onload = initializeFirebase;

    </script>
</body>
</html>